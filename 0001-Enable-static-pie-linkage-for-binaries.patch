From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Patrick McCarty <patrick.mccarty@intel.com>
Date: Mon, 12 Apr 2021 15:05:32 -0700
Subject: [PATCH] Enable static-pie linkage for binaries

Signed-off-by: Patrick McCarty <patrick.mccarty@intel.com>
Signed-off-by: Mark D Horn <mark.d.horn@intel.com>
---
 Makefile | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/Makefile b/Makefile
index 55b205b97eed..69b6f24692c5 100644
--- a/Makefile
+++ b/Makefile
@@ -16,8 +16,8 @@ GO ?= go
 
 # test for go module support
 ifeq ($(shell go help mod >/dev/null 2>&1 && echo true), true)
-export GO_BUILD=GO111MODULE=on $(GO) build -mod=vendor
-export GO_TEST=GO111MODULE=on $(GO) test -mod=vendor
+export GO_BUILD=GO111MODULE=auto $(GO) build -mod=vendor -buildmode=pie
+export GO_TEST=GO111MODULE=auto $(GO) test -mod=vendor -buildmode=pie
 else
 export GO_BUILD=$(GO) build
 export GO_TEST=$(GO) test
@@ -33,8 +33,8 @@ BINDIR ?= /usr/local/bin
 
 VERSION := $(shell git describe --tags --dirty --always)
 VERSION := $(VERSION:v%=%)
-GO_LDFLAGS := -X $(PROJECT)/pkg/version.Version=$(VERSION)
-BUILDTAGS := selinux
+GO_LDFLAGS := -X $(PROJECT)/pkg/version.Version=$(VERSION) -linkmode external -extldflags "-static-pie"
+BUILDTAGS := selinux,netgo,osusergo
 
 BUILD_PATH := $(shell pwd)/build
 BUILD_BIN_PATH := $(BUILD_PATH)/bin
@@ -57,13 +57,13 @@ help:
 	@echo " * 'clean' - Clean artifacts."
 
 critest:
-	CGO_ENABLED=0 $(GO_TEST) -c -o $(CURDIR)/_output/critest$(BIN_EXT) \
+	$(GO_TEST) -c -o $(CURDIR)/_output/critest$(BIN_EXT) \
 		-ldflags '$(GO_LDFLAGS)' \
 		-tags '$(BUILDTAGS)' \
 	     $(PROJECT)/cmd/critest
 
 crictl:
-	CGO_ENABLED=0 $(GO_BUILD) -o $(CURDIR)/_output/crictl$(BIN_EXT) \
+	$(GO_BUILD) -o $(CURDIR)/_output/crictl$(BIN_EXT) \
 		-ldflags '$(GO_LDFLAGS)' \
 		-tags '$(BUILDTAGS)' \
 		$(PROJECT)/cmd/crictl
-- 
2.31.1

